==========================================
Feature Space Consistency Analysis
Running all tasks on FULL dataset
Using conda environment: clam_latest
==========================================


==========================================
Processing task: her2
==========================================


================================================================================
FEATURE SPACE CONSISTENCY ANALYSIS
================================================================================
Task:        HER2
Patches dir: data/histomorfologico
Batch size:  32
Device:      cuda
Output:      results/feature_space_analysis
================================================================================


================================================================================
LOADING VIRCHOW V2 MODEL
================================================================================
Device: cuda
Loading Virchow v2 model using project builder...
✓ Model loaded successfully
  Embedding dimension: 2560
================================================================================

Loading patch paths...

TCGA:
  ✓ HER2-negative: 9744 patches
  ✓ HER2-positive: 360 patches

CPTAC:
  ✓ HER2-negative: 2760 patches
  ✓ HER2-positive: 336 patches

================================================================================
Total patches to process:
  TCGA:  10,104 patches
  CPTAC: 3,096 patches
================================================================================


Feature caching enabled: cache/virchow_features
Extracting Virchow v2 features from TCGA patches...

  Processing class: HER2-positive (360 patches)
    Loading cached features from tcga_her2_HER2-positive_features.npz
    ✓ Loaded cached features: (360, 2560)

  Processing class: HER2-negative (9744 patches)
    Loading cached features from tcga_her2_HER2-negative_features.npz
    ✓ Loaded cached features: (9744, 2560)

Extracting Virchow v2 features from CPTAC patches...

  Processing class: HER2-positive (336 patches)
    Loading cached features from cptac_her2_HER2-positive_features.npz
    ✓ Loaded cached features: (336, 2560)

  Processing class: HER2-negative (2760 patches)
    Loading cached features from cptac_her2_HER2-negative_features.npz
    ✓ Loaded cached features: (2760, 2560)

✓ Feature extraction complete

Computing inter-cohort distances...
  Computing distances for HER2-positive: 360 TCGA × 336 CPTAC samples
  Computing distances for HER2-negative: 9744 TCGA × 2760 CPTAC samples

Computing intra-class variability...
  ✓ Distance analysis complete

Computing silhouette scores...
  ✓ Silhouette scores computed

================================================================================
FEATURE SPACE CONSISTENCY ANALYSIS: HER2
================================================================================

Total patches analyzed:
  TCGA:  10,104 high-attention patches
  CPTAC: 3,096 high-attention patches

--------------------------------------------------------------------------------
INTER-COHORT DISTANCES (TCGA ↔ CPTAC)
--------------------------------------------------------------------------------
Class              Mean Dist     TCGA Std    CPTAC Std      Ratio
--------------------------------------------------------------------------------
HER2-positive        49.6250       0.4368       0.5308     102.55
HER2-negative        50.4688       0.4863       0.5435      98.06

Mean inter-cohort distance: 50.0625
Mean intra-class std:       0.4993
Ratio (dist/std):           100.27

--------------------------------------------------------------------------------
SILHOUETTE SCORES
--------------------------------------------------------------------------------
Class                   TCGA        CPTAC          Δ
--------------------------------------------------------------------------------
HER2-negative        -0.0291       0.0065    +0.0356
HER2-positive         0.0745       0.0123    -0.0622

Average silhouette (TCGA):  -0.0254
Average silhouette (CPTAC): 0.0071
Difference:                 +0.0326

================================================================================
INTERPRETATION
================================================================================
✗ Centroid distances are LARGER than intra-class variability.
  → Feature representations show DOMAIN SHIFT.

✓ Silhouette scores are SIMILAR between cohorts.
  → Class separability is comparable.

--------------------------------------------------------------------------------
CONCLUSION
--------------------------------------------------------------------------------
Evidence of feature-level domain shift detected.
Attended regions show different feature representations across cohorts.
================================================================================

Saving results...
  ✓ Saved: her2_inter_cohort_distances.csv
  ✓ Saved: her2_silhouette_scores.csv
  ✓ Saved: her2_feature_space_analysis.json

Generating visualizations...
  ✓ Saved: her2_centroid_distances.png
  ✓ Saved: her2_silhouette_comparison.png
  Subsampling to 5000 points for t-SNE...
  Computing t-SNE (this may take a while)...
  ✓ Saved: her2_tsne_embeddings.png

================================================================================
ANALYSIS COMPLETE
================================================================================

Results saved to: results/feature_space_analysis/


✓ Task her2 completed successfully

==========================================
Processing task: er
==========================================


================================================================================
FEATURE SPACE CONSISTENCY ANALYSIS
================================================================================
Task:        ER
Patches dir: data/histomorfologico
Batch size:  32
Device:      cuda
Output:      results/feature_space_analysis
================================================================================


================================================================================
LOADING VIRCHOW V2 MODEL
================================================================================
Device: cuda
Loading Virchow v2 model using project builder...
✓ Model loaded successfully
  Embedding dimension: 2560
================================================================================

Loading patch paths...

TCGA:
  ✓ ER-negative: 2032 patches
  ✓ ER-positive: 8568 patches

CPTAC:
  ✓ ER-negative: 1152 patches
  ✓ ER-positive: 1880 patches

================================================================================
Total patches to process:
  TCGA:  10,600 patches
  CPTAC: 3,032 patches
================================================================================


Feature caching enabled: cache/virchow_features
Extracting Virchow v2 features from TCGA patches...

  Processing class: ER-positive (8568 patches)
    Loading cached features from tcga_er_ER-positive_features.npz
    ✓ Loaded cached features: (8568, 2560)

  Processing class: ER-negative (2032 patches)
    Loading cached features from tcga_er_ER-negative_features.npz
    ✓ Loaded cached features: (2032, 2560)

Extracting Virchow v2 features from CPTAC patches...

  Processing class: ER-negative (1152 patches)
    Loading cached features from cptac_er_ER-negative_features.npz
    ✓ Loaded cached features: (1152, 2560)

  Processing class: ER-positive (1880 patches)
    Loading cached features from cptac_er_ER-positive_features.npz
    ✓ Loaded cached features: (1880, 2560)

✓ Feature extraction complete

Computing inter-cohort distances...
  Computing distances for ER-positive: 8568 TCGA × 1880 CPTAC samples
  Computing distances for ER-negative: 2032 TCGA × 1152 CPTAC samples

Computing intra-class variability...
  ✓ Distance analysis complete

Computing silhouette scores...
  ✓ Silhouette scores computed

================================================================================
FEATURE SPACE CONSISTENCY ANALYSIS: ER
================================================================================

Total patches analyzed:
  TCGA:  10,600 high-attention patches
  CPTAC: 3,032 high-attention patches

--------------------------------------------------------------------------------
INTER-COHORT DISTANCES (TCGA ↔ CPTAC)
--------------------------------------------------------------------------------
Class              Mean Dist     TCGA Std    CPTAC Std      Ratio
--------------------------------------------------------------------------------
ER-positive          48.2500       0.4797       0.5347      95.11
ER-negative          49.3438       0.4585       0.5591      96.98

Mean inter-cohort distance: 48.8125
Mean intra-class std:       0.5081
Ratio (dist/std):           96.08

--------------------------------------------------------------------------------
SILHOUETTE SCORES
--------------------------------------------------------------------------------
Class                   TCGA        CPTAC          Δ
--------------------------------------------------------------------------------
ER-negative           0.0920       0.0097    -0.0823
ER-positive           0.0891       0.0545    -0.0346

Average silhouette (TCGA):  0.0897
Average silhouette (CPTAC): 0.0375
Difference:                 -0.0522

================================================================================
INTERPRETATION
================================================================================
✗ Centroid distances are LARGER than intra-class variability.
  → Feature representations show DOMAIN SHIFT.

✓ Silhouette scores are SIMILAR between cohorts.
  → Class separability is comparable.

--------------------------------------------------------------------------------
CONCLUSION
--------------------------------------------------------------------------------
Evidence of feature-level domain shift detected.
Attended regions show different feature representations across cohorts.
================================================================================

Saving results...
  ✓ Saved: er_inter_cohort_distances.csv
  ✓ Saved: er_silhouette_scores.csv
  ✓ Saved: er_feature_space_analysis.json

Generating visualizations...
  ✓ Saved: er_centroid_distances.png
  ✓ Saved: er_silhouette_comparison.png
  Subsampling to 5000 points for t-SNE...
  Computing t-SNE (this may take a while)...
  ✓ Saved: er_tsne_embeddings.png

================================================================================
ANALYSIS COMPLETE
================================================================================

Results saved to: results/feature_space_analysis/


✓ Task er completed successfully

==========================================
Processing task: pr
==========================================


================================================================================
FEATURE SPACE CONSISTENCY ANALYSIS
================================================================================
Task:        PR
Patches dir: data/histomorfologico
Batch size:  32
Device:      cuda
Output:      results/feature_space_analysis
================================================================================


================================================================================
LOADING VIRCHOW V2 MODEL
================================================================================
Device: cuda
Loading Virchow v2 model using project builder...
✓ Model loaded successfully
  Embedding dimension: 2560
================================================================================

Loading patch paths...

TCGA:
  ✓ PR-negative: 2688 patches
  ✓ PR-positive: 6839 patches

CPTAC:
  ✓ PR-negative: 1352 patches
  ✓ PR-positive: 1640 patches

================================================================================
Total patches to process:
  TCGA:  9,527 patches
  CPTAC: 2,992 patches
================================================================================


Feature caching enabled: cache/virchow_features
Extracting Virchow v2 features from TCGA patches...

  Processing class: PR-positive (6839 patches)
    Loading cached features from tcga_pr_PR-positive_features.npz
    ✓ Loaded cached features: (6839, 2560)

  Processing class: PR-negative (2688 patches)
    Loading cached features from tcga_pr_PR-negative_features.npz
    ✓ Loaded cached features: (2688, 2560)

Extracting Virchow v2 features from CPTAC patches...

  Processing class: PR-negative (1352 patches)
    Loading cached features from cptac_pr_PR-negative_features.npz
    ✓ Loaded cached features: (1352, 2560)

  Processing class: PR-positive (1640 patches)
    Loading cached features from cptac_pr_PR-positive_features.npz
    ✓ Loaded cached features: (1640, 2560)

✓ Feature extraction complete

Computing inter-cohort distances...
  Computing distances for PR-positive: 6839 TCGA × 1640 CPTAC samples
  Computing distances for PR-negative: 2688 TCGA × 1352 CPTAC samples

Computing intra-class variability...
  ✓ Distance analysis complete

Computing silhouette scores...
  ✓ Silhouette scores computed

================================================================================
FEATURE SPACE CONSISTENCY ANALYSIS: PR
================================================================================

Total patches analyzed:
  TCGA:  9,527 high-attention patches
  CPTAC: 2,992 high-attention patches

--------------------------------------------------------------------------------
INTER-COHORT DISTANCES (TCGA ↔ CPTAC)
--------------------------------------------------------------------------------
Class              Mean Dist     TCGA Std    CPTAC Std      Ratio
--------------------------------------------------------------------------------
PR-positive          51.5938       0.4956       0.5581      97.93
PR-negative          50.9688       0.4382       0.5615     101.94

Mean inter-cohort distance: 51.2812
Mean intra-class std:       0.5134
Ratio (dist/std):           99.88

--------------------------------------------------------------------------------
SILHOUETTE SCORES
--------------------------------------------------------------------------------
Class                   TCGA        CPTAC          Δ
--------------------------------------------------------------------------------
PR-negative           0.1166       0.0097    -0.1069
PR-positive           0.0042       0.0127    +0.0085

Average silhouette (TCGA):  0.0359
Average silhouette (CPTAC): 0.0113
Difference:                 -0.0246

================================================================================
INTERPRETATION
================================================================================
✗ Centroid distances are LARGER than intra-class variability.
  → Feature representations show DOMAIN SHIFT.

✓ Silhouette scores are SIMILAR between cohorts.
  → Class separability is comparable.

--------------------------------------------------------------------------------
CONCLUSION
--------------------------------------------------------------------------------
Evidence of feature-level domain shift detected.
Attended regions show different feature representations across cohorts.
================================================================================

Saving results...
  ✓ Saved: pr_inter_cohort_distances.csv
  ✓ Saved: pr_silhouette_scores.csv
  ✓ Saved: pr_feature_space_analysis.json

Generating visualizations...
  ✓ Saved: pr_centroid_distances.png
  ✓ Saved: pr_silhouette_comparison.png
  Subsampling to 5000 points for t-SNE...
  Computing t-SNE (this may take a while)...
  ✓ Saved: pr_tsne_embeddings.png

================================================================================
ANALYSIS COMPLETE
================================================================================

Results saved to: results/feature_space_analysis/


✓ Task pr completed successfully

==========================================
Processing task: pam50
==========================================


================================================================================
FEATURE SPACE CONSISTENCY ANALYSIS
================================================================================
Task:        PAM50
Patches dir: data/histomorfologico
Batch size:  32
Device:      cuda
Output:      results/feature_space_analysis
================================================================================


================================================================================
LOADING VIRCHOW V2 MODEL
================================================================================
Device: cuda
Loading Virchow v2 model using project builder...
✓ Model loaded successfully
  Embedding dimension: 2560
================================================================================

Loading patch paths...

TCGA:
  ✓ Basal: 1720 patches
  ✓ Her2: 392 patches
  ✓ LumA: 5688 patches
  ✓ LumB: 1864 patches
  ✓ Normal: 192 patches

CPTAC:
  ✓ Basal: 1434 patches
  ✓ Her2: 312 patches
  ✓ LumA: 2483 patches
  ✓ LumB: 498 patches
  ✓ Normal: 112 patches

================================================================================
Total patches to process:
  TCGA:  9,856 patches
  CPTAC: 4,839 patches
================================================================================


Feature caching enabled: cache/virchow_features
Extracting Virchow v2 features from TCGA patches...

  Processing class: Basal (1720 patches)
    Loading cached features from tcga_pam50_Basal_features.npz
    ✓ Loaded cached features: (1720, 2560)

  Processing class: Normal (192 patches)
    Loading cached features from tcga_pam50_Normal_features.npz
    ✓ Loaded cached features: (192, 2560)

  Processing class: Her2 (392 patches)
    Loading cached features from tcga_pam50_Her2_features.npz
    ✓ Loaded cached features: (392, 2560)

  Processing class: LumB (1864 patches)
    Loading cached features from tcga_pam50_LumB_features.npz
    ✓ Loaded cached features: (1864, 2560)

  Processing class: LumA (5688 patches)
    Loading cached features from tcga_pam50_LumA_features.npz
    ✓ Loaded cached features: (5688, 2560)

Extracting Virchow v2 features from CPTAC patches...

  Processing class: Basal (1434 patches)
    Loading cached features from cptac_pam50_Basal_features.npz
    ✓ Loaded cached features: (1434, 2560)

  Processing class: LumA (2483 patches)
    Loading cached features from cptac_pam50_LumA_features.npz
    ✓ Loaded cached features: (2483, 2560)

  Processing class: Normal (112 patches)
    Loading cached features from cptac_pam50_Normal_features.npz
    ✓ Loaded cached features: (112, 2560)

  Processing class: Her2 (312 patches)
    Loading cached features from cptac_pam50_Her2_features.npz
    ✓ Loaded cached features: (312, 2560)

  Processing class: LumB (498 patches)
    Loading cached features from cptac_pam50_LumB_features.npz
    ✓ Loaded cached features: (498, 2560)

✓ Feature extraction complete

Computing inter-cohort distances...
  Computing distances for Basal: 1720 TCGA × 1434 CPTAC samples
  Computing distances for Normal: 192 TCGA × 112 CPTAC samples
  Computing distances for Her2: 392 TCGA × 312 CPTAC samples
  Computing distances for LumB: 1864 TCGA × 498 CPTAC samples
  Computing distances for LumA: 5688 TCGA × 2483 CPTAC samples

Computing intra-class variability...
  ✓ Distance analysis complete

Computing silhouette scores...
  ✓ Silhouette scores computed

================================================================================
FEATURE SPACE CONSISTENCY ANALYSIS: PAM50
================================================================================

Total patches analyzed:
  TCGA:  9,856 high-attention patches
  CPTAC: 4,839 high-attention patches

--------------------------------------------------------------------------------
INTER-COHORT DISTANCES (TCGA ↔ CPTAC)
--------------------------------------------------------------------------------
Class              Mean Dist     TCGA Std    CPTAC Std      Ratio
--------------------------------------------------------------------------------
Basal                49.3125       0.4204       0.5342     103.32
Normal               53.5000       0.4854       0.5356     104.75
Her2                 48.4375       0.4075       0.5420     102.06
LumB                 51.6250       0.4807       0.5342     101.76
LumA                 46.9688       0.4741       0.5264      93.94

Mean inter-cohort distance: 49.9688
Mean intra-class std:       0.4940
Ratio (dist/std):           101.15

--------------------------------------------------------------------------------
SILHOUETTE SCORES
--------------------------------------------------------------------------------
Class                   TCGA        CPTAC          Δ
--------------------------------------------------------------------------------
Basal                 0.1177       0.0080    -0.1097
Her2                  0.1104      -0.0167    -0.1271
LumA                 -0.0322       0.0229    +0.0551
LumB                 -0.0385      -0.0214    +0.0171
Normal                0.0664      -0.0200    -0.0863

Average silhouette (TCGA):  0.0004
Average silhouette (CPTAC): 0.0104
Difference:                 +0.0100

================================================================================
INTERPRETATION
================================================================================
✗ Centroid distances are LARGER than intra-class variability.
  → Feature representations show DOMAIN SHIFT.

✓ Silhouette scores are SIMILAR between cohorts.
  → Class separability is comparable.

--------------------------------------------------------------------------------
CONCLUSION
--------------------------------------------------------------------------------
Evidence of feature-level domain shift detected.
Attended regions show different feature representations across cohorts.
================================================================================

Saving results...
  ✓ Saved: pam50_inter_cohort_distances.csv
  ✓ Saved: pam50_silhouette_scores.csv
  ✓ Saved: pam50_feature_space_analysis.json

Generating visualizations...
  ✓ Saved: pam50_centroid_distances.png
  ✓ Saved: pam50_silhouette_comparison.png
  Subsampling to 5000 points for t-SNE...
  Computing t-SNE (this may take a while)...
  ✓ Saved: pam50_tsne_embeddings.png

================================================================================
ANALYSIS COMPLETE
================================================================================

Results saved to: results/feature_space_analysis/


✓ Task pam50 completed successfully

==========================================
All tasks completed!
==========================================

Results saved to: results/feature_space_analysis
Cache saved to: cache/virchow_features
